.row
  .col-md-12
    - if @scenario_import.existing_scenario.present?
      .alert.alert-warning
        %span.glyphicon.glyphicon-warning-sign
        This Scenario already exists in Huginn.io. The import will update your existing
        = scenario_label(@scenario_import.existing_scenario)
        Scenario's title,
        description, and tag colors. Please verify the changes below.

    .page-header
      %h2
        = @scenario_import.parsed_data["name"]
        %span.text-muted
          = "(#{pluralize(@scenario_import.parsed_data["agents"].length, "Agent")}; exported #{time_ago_in_words(Time.parse(@scenario_import.parsed_data["exported_at"]))} ago)"

    - if @scenario_import.parsed_data["description"].present?
      %blockquote= markdown(@scenario_import.parsed_data["description"])

.agent-import-list
  - @scenario_import.agent_diffs.each.with_index do |agent_diff, index|
    .agent-import{"data-index": index}
      .row
        .col-md-12
          %h3
            %a{href: '#', data: {toggle: 'modal', target: "#agent_options_#{index}"}}= agent_diff.name.incoming
            %span.text-muted
              = "(#{agent_diff.type.incoming}#{" -- WARNING: this Agent's type has been changed. This import will likely fail!" if agent_diff.type.requires_merge?})"

          - if agent_diff.agent_exists?
            .form-group
              This Agent exists in your Huginn.io Scenario.

              - if agent_diff.requires_merge?
                Here are the differences between the upload version and the one you have now. Confirming the import will update the options to the uploaded data.

              - else
                It's already up-to-date.

      .modal.fade{id: "agent_options_#{index}", tabindex: "-1", role: "dialog", "aria-labelledby": "modalLabel#{index}", "aria-hidden": true}
        .modal-dialog.modal-lg
          .modal-content
            .modal-header
              %button.close{type: "button", "data-dismiss": 'modal', "aria-hidden2": true}
                &times
              %h4.modal-title{id: "modalLabel#{index}"}
                = "Options for '#{agent_diff.name.updated}'"
            .modal-body
              %pre.options= Utils.pretty_jsonify agent_diff.options.incoming

      - agent_diff.each_field do |field, value|
        .row
          .col-md-12
            .form-group
              = label_tag "", field.titleize
              changed from
              %code
                = value.current.to_s
              = " to "
              %code
                = value.updated

      .row
        - if agent_diff.options.requires_merge?
          .col-md-12
            %label
              Options
          .col-md-12
            %pre.options{'data-index': index}
          :coffeescript
            old = #{agent_diff.options.current.to_json}
            updated = #{agent_diff.options.updated.to_json}
            delta = jsondiffpatch.diff(old, updated)
            $("pre[data-index=#{index}]").html(jsondiffpatch.formatters.html.format(delta, old))

.row
  .col-md-12
    .checkbox
      = f.label :do_import do
        = f.check_box :do_import
        I confirm that I want to import these Agents.

    .form-actions
      = f.submit "Finish Import", class: "btn btn-primary"
